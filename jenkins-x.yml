buildPack: go
pipelineConfig:
  env:
  - name: CODECOV_TOKEN
    valueFrom:
      secretKeyRef:
        key: token
        name: codecov
  pipelines:
    pullRequest:
      build:
        preSteps:
        # This is new
        - loop:
            variable: GOOS
            values:
            - darwin
            - linux
            - windows
            steps:
            - name: build
              command: GOOS=${GOOS} GOARCH=amd64 go build -o bin/go-demo-6_${GOOS} main.go
        #Â TODO: Remove
        - name: something
          command: ls -l bin
        - name: unit-tests
          command: make unittest
        - name: code-coverage
          command: codecov.sh
          agent:
            image: vfarcic/codecov
      promote:
        steps:
        - name: rollout
          command: |
            NS=`echo cd-$REPO_OWNER-go-demo-6-$BRANCH_NAME | tr '[:upper:]' '[:lower:]'`
            kubectl -n $NS rollout status deployment preview-preview
        - name: functional-tests
          command: ADDRESS=`jx get preview --current 2>&1` make functest

